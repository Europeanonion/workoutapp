<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Workout Plan + Tracker (Adaptive)</title>
  <style>
    /* Same styles as before or customize as needed */
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f7f7f7;
      color: #333;
    }
    header {
      background: #2c3e50;
      color: #fff;
      padding: 1rem;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    header h1 { margin: 0; font-size: 1.5rem; }
    main { padding: 1rem; max-width: 800px; margin: 0 auto; text-align: center; }

    /* ... rest of your CSS from the previous version ... */

  </style>
</head>
<body>
  <header>
    <h1>Workout Plan + Tracker</h1>
  </header>

  <main>
    <!-- PHASE SELECTOR + RESET -->
    <label for="phase-selector">Select Workout Phase:</label>
    <select id="phase-selector" title="Select Workout Phase" aria-label="Workout Phase"></select>

    <button class="reset-btn" id="reset-data-btn" aria-label="Reset all saved workout data">
      Reset All Data
    </button>

    <!-- WORKOUT CONTAINER -->
    <div id="workout-container"></div>

    <!-- TRACKER CONTROLS -->
    <div class="tracker-controls">
      <button class="export-btn" id="show-history-btn" aria-label="Show workout history">
        Show History
      </button>
      <button class="export-btn" id="export-csv-btn" aria-label="Export workout history as CSV">
        Export CSV
      </button>
    </div>

    <!-- HISTORY SECTION -->
    <div class="history-section" id="history-section">
      <h2>Workout History</h2>
      <p id="history-stats"></p>
      <table id="history-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Exercise</th>
            <th>Sets</th>
            <th>Reps</th>
            <th>Load</th>
            <th>Volume</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <button class="history-close-btn" id="close-history-btn" aria-label="Close history view">
        Close
      </button>
    </div>
  </main>

  <script>
    // 1. BASE PATH FOR YOUR GITHUB PAGES
    const basePath = "https://yourusername.github.io/workoutapp/";

    // 2. ON WINDOW LOAD, FETCH phase_index.json FIRST
    window.addEventListener("load", init);

    async function init() {
      try {
        // Fetch the phase index JSON
        const indexResponse = await fetch(basePath + "phase_index.json");
        if (!indexResponse.ok) throw new Error(`Index fetch error: ${indexResponse.status}`);
        const indexData = await indexResponse.json();

        // Populate the <select> with the retrieved phases
        populatePhaseSelector(indexData.phases);

        // Bind event listeners
        bindUIEvents();

        // Load previously selected phase OR default to first
        loadSavedPhase();
      } catch (error) {
        console.error("Error loading phase index:", error);
        alert("Failed to load phase index. Check console for details.");
      }
    }

    // 3. CREATE DROPDOWN OPTIONS DYNAMICALLY
    function populatePhaseSelector(phases) {
      const phaseSelector = document.getElementById("phase-selector");
      phases.forEach(phase => {
        const optionEl = document.createElement("option");
        optionEl.value = phase.file;      // store the JSON filename as the value
        optionEl.textContent = phase.label; // display label
        phaseSelector.appendChild(optionEl);
      });
    }

    // 4. BIND UI EVENTS
    function bindUIEvents() {
      document.getElementById("phase-selector").addEventListener("change", handlePhaseChange);
      document.getElementById("reset-data-btn").addEventListener("click", resetAllData);
      document.getElementById("show-history-btn").addEventListener("click", toggleHistory);
      document.getElementById("close-history-btn").addEventListener("click", toggleHistory);
      document.getElementById("export-csv-btn").addEventListener("click", exportCSV);
    }

    // 5. LOAD SAVED PHASE OR DEFAULT (FIRST OPTION)
    function loadSavedPhase() {
      const savedPhase = localStorage.getItem("selectedPhase");
      const phaseSelector = document.getElementById("phase-selector");

      if (savedPhase) {
        phaseSelector.value = savedPhase;
        loadWorkout(savedPhase);
      } else {
        // default to the first option
        const firstOption = phaseSelector.options[0];
        if (firstOption) {
          phaseSelector.value = firstOption.value;
          loadWorkout(firstOption.value);
        }
      }
    }

    // 6. PHASE CHANGE HANDLER
    function handlePhaseChange() {
      const selectedPhase = document.getElementById("phase-selector").value;
      localStorage.setItem("selectedPhase", selectedPhase);
      loadWorkout(selectedPhase);
    }

    // 7. FETCH & DISPLAY WORKOUT
    async function loadWorkout(phaseFile) {
      const url = basePath + phaseFile;
      try {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);

        const data = await response.json();
        if (!Array.isArray(data) || data.length === 0) {
          throw new Error("Invalid or empty JSON data");
        }
        displayWorkout(data);
      } catch (error) {
        console.error("Error fetching workout JSON:", error);
        alert("Failed to load workout data. Check console for errors.");
      }
    }

    function displayWorkout(data) {
      const container = document.getElementById("workout-container");
      container.innerHTML = "";

      let currentPhase = "";
      let currentWeek = "";

      data.forEach((workout, index) => {
        if (workout.Phase !== currentPhase) {
          currentPhase = workout.Phase;
          const phaseHeader = document.createElement("div");
          phaseHeader.classList.add("phase");
          phaseHeader.textContent = currentPhase;
          container.appendChild(phaseHeader);
        }

        if (workout.Week !== currentWeek) {
          currentWeek = workout.Week;
          const weekHeader = document.createElement("div");
          weekHeader.classList.add("week");
          weekHeader.textContent = `Week ${currentWeek}`;
          container.appendChild(weekHeader);
        }

        container.appendChild(createExerciseElement(workout, index));
      });
    }

    // 8. CREATE EXERCISE ELEMENT
    function createExerciseElement(workout, index) {
      const exerciseDiv = document.createElement("div");
      exerciseDiv.classList.add("exercise");

      const setsValue = getSavedValue(index, "sets") || workout["Working Sets"] || "";
      const repsValue = getSavedValue(index, "reps") || workout.Reps || "";
      const loadValue = getSavedValue(index, "load") || "";

      exerciseDiv.innerHTML = `
        <h2>
          <a href="${workout.ExerciseLink || '#'}" target="_blank">
            ${workout.Exercise || 'Untitled Exercise'}
          </a>
        </h2>
        <p><strong>Sets:</strong>
          <input type="number" min="0" aria-label="Sets for ${workout.Exercise}"
                 id="sets-${index}" value="${setsValue}" />
        </p>
        <p><strong>Reps:</strong>
          <input type="number" min="0" aria-label="Reps for ${workout.Exercise}"
                 id="reps-${index}" value="${repsValue}" />
        </p>
        <p><strong>Load (kg):</strong>
          <input type="number" min="0" aria-label="Load for ${workout.Exercise}"
                 id="load-${index}" placeholder="Weight" value="${loadValue}" />
        </p>
        <p><strong>Rest:</strong> ${workout.Rest || 'N/A'}</p>
        <p><strong>Notes:</strong> ${workout.Notes || 'No notes available'}</p>
        <p><strong>Substitution 1:</strong>
          <a href="${workout["Substitution Option 1 Link"] || '#'}" target="_blank">
            ${workout["Substitution Option 1"] || 'N/A'}
          </a>
        </p>
        <p><strong>Substitution 2:</strong>
          <a href="${workout["Substitution Option 2 Link"] || '#'}" target="_blank">
            ${workout["Substitution Option 2"] || 'N/A'}
          </a>
        </p>
        <button class="save-btn" aria-label="Save workout data for ${workout.Exercise}"
                id="save-btn-${index}">
          Save
        </button>
      `;

      // Save button click
      exerciseDiv.querySelector(`#save-btn-${index}`).addEventListener("click", () => {
        saveProgress(index, workout.Exercise);
      });

      return exerciseDiv;
    }

    // 9. SAVE PROGRESS
    function saveProgress(index, exerciseName) {
      const sets = document.getElementById(`sets-${index}`).value.trim();
      const reps = document.getElementById(`reps-${index}`).value.trim();
      const load = document.getElementById(`load-${index}`).value.trim();

      if (!validateNumber(sets) || !validateNumber(reps) || !validateNumber(load)) {
        alert(`Please ensure sets, reps, and load are numeric (Exercise: ${exerciseName}).`);
        return;
      }
      localStorage.setItem(`workout-${index}`, JSON.stringify({ sets, reps, load }));
      saveToHistory(exerciseName, sets, reps, load);
      showSaveConfirmation(index);
    }

    // 10. HELPER FUNCTIONS
    function validateNumber(value) {
      return value === "" || /^[0-9]+$/.test(value);
    }

    function showSaveConfirmation(index) {
      const btn = document.getElementById(`save-btn-${index}`);
      const originalText = btn.textContent;
      btn.textContent = "Saved!";
      btn.disabled = true;
      setTimeout(() => {
        btn.textContent = originalText;
        btn.disabled = false;
      }, 1500);
    }

    function getSavedValue(index, key) {
      const savedData = localStorage.getItem(`workout-${index}`);
      return savedData ? JSON.parse(savedData)[key] : null;
    }

    // 11. HISTORY
    function saveToHistory(exercise, sets, reps, load) {
      const historyData = JSON.parse(localStorage.getItem("workoutHistory")) || [];
      const date = new Date().toISOString();
      historyData.push({
        date,
        exercise,
        sets: Number(sets) || 0,
        reps: Number(reps) || 0,
        load: Number(load) || 0
      });
      localStorage.setItem("workoutHistory", JSON.stringify(historyData));
    }

    function toggleHistory() {
      const historySection = document.getElementById("history-section");
      const isHidden = !historySection.style.display || historySection.style.display === "none";
      if (isHidden) {
        updateHistoryTable();
        historySection.style.display = "block";
      } else {
        historySection.style.display = "none";
      }
    }

    function updateHistoryTable() {
      const historyData = JSON.parse(localStorage.getItem("workoutHistory")) || [];
      const tableBody = document.querySelector("#history-table tbody");
      tableBody.innerHTML = "";

      let totalVolume = 0;

      // You can sort if you want: 
      // historyData.sort((a, b) => new Date(b.date) - new Date(a.date));

      historyData.forEach(entry => {
        const row = document.createElement("tr");
        const volume = entry.sets * entry.reps * entry.load;
        totalVolume += volume;

        row.innerHTML = `
          <td>${formatDate(entry.date)}</td>
          <td>${entry.exercise}</td>
          <td>${entry.sets}</td>
          <td>${entry.reps}</td>
          <td>${entry.load}</td>
          <td>${volume}</td>
        `;
        tableBody.appendChild(row);
      });

      const statsEl = document.getElementById("history-stats");
      statsEl.textContent = `Total Logged Entries: ${historyData.length} | Cumulative Volume: ${totalVolume}`;
    }

    function formatDate(dateString) {
      const d = new Date(dateString);
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      const hours = String(d.getHours()).padStart(2, "0");
      const mins = String(d.getMinutes()).padStart(2, "0");
      return `${year}-${month}-${day} ${hours}:${mins}`;
    }

    // 12. EXPORT CSV
    function exportCSV() {
      const historyData = JSON.parse(localStorage.getItem("workoutHistory")) || [];
      if (!historyData.length) {
        alert("No history data to export.");
        return;
      }

      let csvContent = "Date,Exercise,Sets,Reps,Load,Volume\n";
      historyData.forEach(entry => {
        const volume = entry.sets * entry.reps * entry.load;
        csvContent += `"${formatDate(entry.date)}","${entry.exercise}",${entry.sets},${entry.reps},${entry.load},${volume}\n`;
      });

      const blob = new Blob([csvContent], { type: "text/csv" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "workout_history.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // 13. RESET ALL DATA
    function resetAllData() {
      if (!confirm("Are you sure you want to clear ALL workout data?")) return;

      Object.keys(localStorage).forEach(key => {
        if (key.startsWith("workout-") || key === "workoutHistory") {
          localStorage.removeItem(key);
        }
      });
      alert("All saved workout data has been cleared.");

      // Reload the current phase
      const currentPhase = document.getElementById("phase-selector").value;
      loadWorkout(currentPhase);
    }
  </script>
</body>
</html>